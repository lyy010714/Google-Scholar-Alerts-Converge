<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Scholar Alerts</title>
    <!-- 引入Bootstrap样式 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    <!-- 引入jQuery和DataTables -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='jquery.dataTables.min.css') }}">
    <script src="{{ url_for('static', filename='jquery-3.5.1.js') }}"></script>
    <script src="{{ url_for('static', filename='jquery.dataTables.min.js') }}"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .button-container {
            position: absolute;
            top: 30px;
            left: 30px;
        }

        .search-container {
            position: absolute;
            top: 40px;
            right: 30px;
        }

        .button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 10px;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .table-container {
            width: 96%; 
            margin: 0 auto;
            text-align: center; 
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }

        th, td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: center;
            overflow: hidden;
            white-space: normal;
        }

        th {
            background-color: #f2f2f2;
            vertical-align: middle;
        }

        td:first-child {
            text-align: left;
        }

        tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tbody tr:hover {
            background-color: #ddd;
        }

        .dataTables_filter {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Google Scholar Alerts</h1>
        
        <br>
        
        <div class="button-container">
            <button id="exportButton" class="button">Export</button>
            <button id="checkButton" class="button">Check Now</button>
        </div>

        <div class="search-container">
            <input type="text" id="searchBox" placeholder="Search...">
        </div>
    </div>
    
    <div class="table-container">
        <table id="myTable" class="table table-striped table-bordered">
            <thead>
                <!-- 第一行：标题 -->
                <tr>
                    <th style="width: 40%;">Title</th>
                    <th style="width: 30%;">Journal</th>
                    <th style="width: 10%;">Date</th>
                    <th style="width: 10%;">New article</th>
                    <th style="width: 10%;">Related with</th>
                    <th style="width: 10%;">Subject</th>
                </tr>
                <!-- 第二行：筛选控件 -->
                <tr>
                    <th></th>   <!-- Title -->
                    <th></th>   <!-- Journal -->
                    <th></th>   <!-- Date -->
                    <th></th>
                    <th></th>
                    <th></th>   <!-- Subject -->
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td class="link"><a href="{{ row[4] }}" target="_blank">{{ row[0] }}</a></td>
                    <td class="journal">{{ row[2] }}</td>
                    <td>{{ row[3] }}</td>
                    <td>{{ row[8] }}</td>
                    <td>{{ row[10] }}</td>
                    <td>{{ row[11] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
    $(document).ready(function () {
        var table = $('#myTable').DataTable({
            orderCellsTop: true,   // 关键：允许多行表头
            fixedHeader: true,
            "dom": '<"top"f>rt<"bottom"lip><"clear">',
            "paging": true,
            "ordering": true,
            "searching": true,
            "order": [[2, 'desc']],
            initComplete: function () {
                var api = this.api();

                // Journal (col 1) 和 Subject (col 6) 下拉框
                api.columns([3]).every(function () {
                    var column = this;
                    var select = $('<select><option value="">All</option></select>')
                        .appendTo($(api.table().header()).find('tr:eq(1) th').eq(column.index()).empty())
                        .on('change', function () {
                            var val = $.fn.dataTable.util.escapeRegex($(this).val());
                            column.search(val ? '^' + val + '$' : '', true, false).draw();
                        });

                    column.data().unique().sort().each(function (d) {
                        if (d) {
                            select.append('<option value="' + d + '">' + d + '</option>');
                        }
                    });
                });

                // Title (col 0), Date (col 2) 文本框
                api.columns([0,1,2,4,5]).every(function () {
                    var column = this;
                    var input = $('<input type="text" placeholder="Search" style="width:100%"/>')
                        .appendTo($(api.table().header()).find('tr:eq(1) th').eq(column.index()).empty())
                        .on('keyup change', function () {
                            if (column.search() !== this.value) {
                                column.search(this.value).draw();
                            }
                        });
                });
            }
        });

        // 原有的 Export / Check 逻辑不变
        $('#exportButton').click(function() {
            var exportButton = $(this);
            exportButton.prop('disabled', true).text('Exporting');
            $.ajax({
                url: '/export',
                method: 'GET',
                xhrFields: { responseType: 'blob' },
                processData: false,
                success: function(data) {
                    var link = document.createElement('a');
                    link.href = URL.createObjectURL(new Blob([data]));
                    link.download = "Alerts_data.csv";
                    link.click();
                    exportButton.text('Export').prop('disabled', false);
                },
                error: function() {
                    exportButton.text('Export Failed').prop('disabled', false);
                }
            });
        });

        $('#checkButton').click(function() {
            var updateButton = $(this);
            updateButton.prop('disabled', true).text('Checking');
            $.get('/check')
                .done(function() { location.reload(); })
                .fail(function() { updateButton.text('Check Failed').prop('disabled', false); });
        });

        // 全局搜索框（保留）
        $('#searchBox').on('keyup', function () {
            var tableApi = $('#myTable').DataTable();
            tableApi.search(this.value).draw();
        });
    });
    </script>
</body>
</html>